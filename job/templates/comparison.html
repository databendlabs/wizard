<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyze Method Comparison</title>
    <!-- SQL Formatter Library -->
    <script src="https://cdn.jsdelivr.net/npm/sql-formatter@12.2.4/dist/sql-formatter.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2196F3;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --info-color: #2196F3;
            --text-primary: #333;
            --text-secondary: #666;
            --text-light: #999;
            --border-color: #e0e0e0;
            --bg-light: #f8f8f8;
            --bg-hover: #f0f7ff;
            --bg-identical: #e8f5e9;
            --header-height: 60px;
            --border-radius: 4px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-primary);
            background-color: #fff;
            line-height: 1.5;
        }
        
        .description {
            margin-bottom: 20px;
            color: var(--text-secondary);
        }
        
        .method-descriptions {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 15px 0;
            padding: 0;
            list-style: none;
        }
        
        .method-descriptions li {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 10px 15px;
            border-radius: 4px;
            flex: 1;
            min-width: 250px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .method-descriptions strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 5px;
            font-size: 1.1em;
        }
        
        .method-descriptions code {
            background-color: #f1f1f1;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            height: var(--header-height);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            padding: 0 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .main {
            flex: 1;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        h1, h2, h3 {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        h2 {
            font-size: 20px;
            margin-bottom: 16px;
        }
        
        h3 {
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        /* Table Styles */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 16px;
            margin-bottom: 32px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            border-right: none;
            border-left: none;
        }
        
        th {
            background-color: var(--bg-light);
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        tr:nth-child(even) {
            background-color: #fafafa;
        }
        
        tr:hover {
            background-color: var(--bg-hover);
        }
        
        .faster {
            font-weight: 500;
        }
        
        .positive {
            color: #28a745;
        }
        
        .negative {
            color: #dc3545;
        }
        
        .noise {
            color: #6c757d;
            font-style: italic;
        }
        
        .noise::after {
            content: ' (\u2248)';
            font-size: 0.9em;
        }
        
        .table-notes {
            margin-top: 15px;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #6c757d;
            border-radius: 4px;
            font-size: 0.9em;
            color: #495057;
        }
        
        .noise-indicator {
            font-style: italic;
            font-weight: bold;
            color: #6c757d;
            margin-right: 5px;
        }
        
        .raw-faster {
            color: #2196F3;
        }
        
        .standard-faster {
            color: #4CAF50;
        }
        
        .histogram-faster {
            color: #9C27B0;
        }
        
        /* Summary Stats */
        .summary {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-item {
            background-color: #fff;
            border-radius: var(--border-radius);
            padding: 16px 20px;
            flex: 1;
            min-width: 200px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Sortable Table Headers */
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: #edf5ff;
        }
        
        .sortable::after {
            content: '\2195';
            margin-left: 5px;
            opacity: 0.5;
            font-size: 12px;
        }
        
        .sortable.asc::after {
            content: '\2191';
            opacity: 1;
        }
        
        .sortable.desc::after {
            content: '\2193';
            opacity: 1;
        }
        
        /* Identical Plans Highlighting */
        tr td.no-diff {
            background-color: var(--bg-identical) !important;
        }
        
        tr:nth-child(even) td.no-diff {
            background-color: #d8ebd9 !important;
        }
        
        /* Modal Styles */
        .explain-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
        }
        
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .copy-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .copy-btn:hover {
            background-color: #1976D2;
        }
        
        .copy-success {
            background-color: var(--success-color) !important;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .close-btn {
            color: var(--text-light);
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            margin: 0;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: var(--text-primary);
        }
        
        .close-btn::after {
            content: '\00D7';
        }
        
        /* Code Content Styles */
        .explain-content {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            background-color: var(--bg-light);
            padding: 12px;
            border-radius: var(--border-radius);
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
        }
        
        .sql-content {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            white-space: pre;
            background-color: transparent;
            padding: 8px 0;
            line-height: 1.5;
            font-size: 13px;
            color: var(--text-primary);
            max-height: 60vh;
            overflow-x: auto;
            overflow-y: auto;
        }
        
        /* Clickable Elements */
        .clickable {
            cursor: pointer;
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .clickable:hover {
            text-decoration: underline;
            background-color: transparent;
        }
        .diff-container { display: flex; flex-direction: column; width: 100%; }
        .diff-header { display: flex; background: #f1f1f1; border: 1px solid #ddd; border-bottom: none; }
        .diff-header-cell { flex: 1; padding: 12px; font-weight: bold; font-size: 14px; }
        .diff-table { display: table; width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-family: monospace; }
        .diff-row { display: table-row; }
        .diff-row:nth-child(even) { background-color: #f8f8f8; }
        .diff-row:hover { background-color: #f0f7ff; }
        .diff-row:hover .diff-removed-row { background-color: #ffe8e8; }
        .diff-row:hover .diff-added-row { background-color: #e0ffe0; }
        .diff-cell { display: table-cell; padding: 0; vertical-align: top; }
        .diff-gutter { width: 40px; text-align: right; color: #999; user-select: none; padding: 0 10px; border-right: 1px solid #eee; }
        .diff-code { padding: 4px 10px; white-space: pre-wrap; width: 50%; line-height: 1.5; }
        .diff-removed-row { background-color: #ffeef0; }
        .diff-removed-row .diff-gutter { background-color: #ffdce0; }
        .diff-added-row { background-color: #e6ffed; }
        .diff-added-row .diff-gutter { background-color: #cdffd8; }
        .diff-marker { display: inline-block; width: 12px; text-align: center; font-weight: bold; padding-right: 8px; }
        .diff-marker-removed { color: #cb2431; }
        .diff-marker-added { color: #22863a; }
        .diff-marker-unchanged { color: transparent; }
    </style>
    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        function showExplain(queryName, method, explainContent) {
            // Set modal content
            var modal = document.getElementById("explainModal");
            var modalTitle = document.getElementById("explainTitle");
            var modalContent = document.getElementById("explainContent");
            
            modalTitle.textContent = queryName + " - " + method + " Execution Plan";
            modalContent.textContent = explainContent || "No explain plan available";
            
            // Show modal
            modal.style.display = "block";
        }
        
        function closeModal() {
            var explainModal = document.getElementById("explainModal");
            var sqlModal = document.getElementById("sqlModal");
            explainModal.style.display = "none";
            sqlModal.style.display = "none";
        }
        
        function closeDiffModal() {
            var modal = document.getElementById("explainDiffModal");
            modal.style.display = "none";
        }
        
        function copyModalContent(elementId) {
            var element = document.getElementById(elementId);
            var button = event.target;
            var originalText = button.textContent;
            
            if (element) {
                // Create a temporary textarea to copy from
                var textArea = document.createElement("textarea");
                textArea.value = element.innerText;
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    // Execute copy command
                    document.execCommand('copy');
                    
                    // Visual feedback
                    button.textContent = "Copied!";
                    button.classList.add("copy-success");
                    
                    // Reset button after 2 seconds
                    setTimeout(function() {
                        button.textContent = originalText;
                        button.classList.remove("copy-success");
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    button.textContent = "Failed";
                    
                    // Reset button after 2 seconds
                    setTimeout(function() {
                        button.textContent = originalText;
                    }, 2000);
                }
                
                // Remove the temporary textarea
                document.body.removeChild(textArea);
            }
        }
        
        function showSql(queryName, sqlContent) {
            // Set modal content
            var modal = document.getElementById("sqlModal");
            var modalTitle = document.getElementById("sqlTitle");
            var modalContent = document.getElementById("sqlContent");
            
            modalTitle.textContent = queryName + " - Full SQL";
            
            if (sqlContent) {
                try {
                    // Ensure we're using the global sqlFormatter object
                    if (typeof sqlFormatter !== 'undefined') {
                        // First, clean up any escaped characters
                        sqlContent = sqlContent.replace(/\\n/g, '\n');
                        
                        // Format the SQL query with explicit formatting options
                        var formattedSql = sqlFormatter.format(sqlContent, {
                            language: 'sql',
                            uppercase: true,
                            linesBetweenQueries: 1,
                            indentStyle: '  ',
                            keywordCase: 'upper',
                            tabulateAlias: true,
                            maxColumnLength: 50
                        });
                        
                        // Set the formatted SQL
                        modalContent.textContent = formattedSql;
                    } else {
                        console.error('SQL Formatter library not loaded');
                        modalContent.textContent = sqlContent; // Fallback
                    }
                } catch (e) {
                    console.error('Error formatting SQL:', e);
                    modalContent.textContent = sqlContent; // Fallback
                }
            } else {
                modalContent.textContent = "SQL not available";
            }
            
            // Show modal
            modal.style.display = "block";
        }
        
        function formatSql(sql) {
            try {
                // Use the third-party SQL formatter library with compact settings
                return sqlFormatter.format(sql, {
                    language: 'sql',
                    uppercase: true,
                    linesBetweenQueries: 1,
                    indentStyle: '  ',  // 2 spaces instead of 4
                    keywordCase: 'upper',
                    tabulateAlias: false,
                    maxColumnLength: 50,
                    params: {},
                    paramTypes: {}
                });
            } catch (e) {
                console.error('Error formatting SQL:', e);
                // Fallback to the original SQL if formatting fails
                return sql;
            }
        }
        
        function showExplainDiff(queryName, method1, method2, plan1, plan2) {
            // Set modal content
            var modal = document.getElementById("explainDiffModal");
            var modalTitle = document.getElementById("explainDiffTitle");
            var diffContent = document.getElementById("diffContent");
            
            modalTitle.textContent = queryName + " - " + method1 + " vs " + method2 + " Execution Plan";
            
            // Determine which method should be shown as added (+)
            // For all comparisons, the first method should be shown as added (+)
            // Std vs Raw: Std is +
            // Hist vs Raw: Hist is +
            // Hist vs Std: Hist is +
            // So in all cases, method1 should be + and method2 should be -
            
            // Create a traditional diff format with + and -
            const diffResult = createDiff(plan2, plan1, method2, method1);
            
            // Set the diff content safely using textContent first, then convert to HTML
            diffContent.innerHTML = diffResult;
            
            // Show modal
            modal.style.display = "block";
        }
        
        function createDiff(text1, text2, label1, label2) {
            // Split both texts into lines
            const lines1 = (text1 || "").split('\n');
            const lines2 = (text2 || "").split('\n');
            
            // Check if plans are identical
            let identical = true;
            if (lines1.length === lines2.length) {
                for (let i = 0; i < lines1.length; i++) {
                    if (lines1[i] !== lines2[i]) {
                        identical = false;
                        break;
                    }
                }
            } else {
                identical = false;
            }
            
            // If plans are identical, show a clear message
            if (identical) {
                return '<div class="diff-header">' +
                       '<div class="diff-header-cell">' + label1 + ' Plan</div>' +
                       '<div class="diff-header-cell">' + label2 + ' Plan</div>' +
                       '</div>' +
                       '<div class="diff-table">' +
                       '<div class="diff-row">' +
                       '<div class="diff-cell" colspan="4" style="text-align: center; padding: 30px; background-color: #e8f5e9;">' +
                       '<div style="font-size: 16px; margin-bottom: 10px;">' +
                       '<span style="color: #2e7d32; font-weight: bold;">✓ IDENTICAL PLANS</span>' +
                       '</div>' +
                       '<div style="color: #555;">' +
                       'No differences found between ' + label1 + ' and ' + label2 + ' execution plans.' +
                       '</div>' +
                       '</div>' +
                       '</div>' +
                       '</div>';
            }
            
            // Create the diff header
            let result = '<div class="diff-header">' +
                         '<div class="diff-header-cell">' + label1 + ' Plan</div>' +
                         '<div class="diff-header-cell">' + label2 + ' Plan</div>' +
                         '</div>' +
                         '<div class="diff-table">';
            
            // Find common lines and differences using a simple LCS algorithm
            const diff = computeDiff(lines1, lines2);
            
            // Generate the side-by-side diff view
            let leftLineNum = 1;
            let rightLineNum = 1;
            
            for (const part of diff) {
                if (part.type === 'common') {
                    // Common lines - show on both sides
                    for (const line of part.lines) {
                        result += '<div class="diff-row">' +
                                  '<div class="diff-cell diff-gutter">' + leftLineNum++ + '</div>' +
                                  '<div class="diff-cell diff-code"><span class="diff-marker diff-marker-unchanged"> </span>' + escapeHtml(line) + '</div>' +
                                  '<div class="diff-cell diff-gutter">' + rightLineNum++ + '</div>' +
                                  '<div class="diff-cell diff-code"><span class="diff-marker diff-marker-unchanged"> </span>' + escapeHtml(line) + '</div>' +
                                  '</div>';
                    }
                } else if (part.type === 'removed') {
                    // Lines only in the left side
                    for (const line of part.lines) {
                        result += '<div class="diff-row diff-removed-row">' +
                                  '<div class="diff-cell diff-gutter">' + leftLineNum++ + '</div>' +
                                  '<div class="diff-cell diff-code"><span class="diff-marker diff-marker-removed">-</span>' + escapeHtml(line) + '</div>' +
                                  '<div class="diff-cell diff-gutter"></div>' +
                                  '<div class="diff-cell diff-code"></div>' +
                                  '</div>';
                    }
                } else if (part.type === 'added') {
                    // Lines only in the right side
                    for (const line of part.lines) {
                        result += '<div class="diff-row diff-added-row">' +
                                  '<div class="diff-cell diff-gutter"></div>' +
                                  '<div class="diff-cell diff-code"></div>' +
                                  '<div class="diff-cell diff-gutter">' + rightLineNum++ + '</div>' +
                                  '<div class="diff-cell diff-code"><span class="diff-marker diff-marker-added">+</span>' + escapeHtml(line) + '</div>' +
                                  '</div>';
                    }
                } else if (part.type === 'modified') {
                    // Modified lines - show on both sides with highlighting
                    for (let i = 0; i < Math.max(part.left.length, part.right.length); i++) {
                        const leftLine = i < part.left.length ? part.left[i] : '';
                        const rightLine = i < part.right.length ? part.right[i] : '';
                        
                        result += '<div class="diff-row">' +
                                  '<div class="diff-cell diff-gutter">' + (leftLine ? leftLineNum++ : '') + '</div>' +
                                  '<div class="diff-cell diff-code' + (leftLine ? ' diff-removed-row' : '') + '">' + 
                                  (leftLine ? '<span class="diff-marker diff-marker-removed">-</span>' + escapeHtml(leftLine) : '') + '</div>' +
                                  '<div class="diff-cell diff-gutter">' + (rightLine ? rightLineNum++ : '') + '</div>' +
                                  '<div class="diff-cell diff-code' + (rightLine ? ' diff-added-row' : '') + '">' + 
                                  (rightLine ? '<span class="diff-marker diff-marker-added">+</span>' + escapeHtml(rightLine) : '') + '</div>' +
                                  '</div>';
                    }
                }
            }
            
            result += '</div>'; // Close diff-table
            
            return result;
        }
        
        function computeDiff(lines1, lines2) {
            const result = [];
            let i = 0, j = 0;
            
            while (i < lines1.length || j < lines2.length) {
                // Find a block of common lines
                let commonStart = i;
                let commonLength = 0;
                
                while (i < lines1.length && j < lines2.length && lines1[i] === lines2[j]) {
                    i++;
                    j++;
                    commonLength++;
                }
                
                if (commonLength > 0) {
                    result.push({
                        type: 'common',
                        lines: lines1.slice(commonStart, commonStart + commonLength)
                    });
                }
                
                // Find blocks of removed and added lines
                const removedStart = i;
                const addedStart = j;
                
                // Look ahead to find the next common line
                let nextCommonI = -1;
                let nextCommonJ = -1;
                
                for (let ii = i; ii < lines1.length; ii++) {
                    for (let jj = j; jj < lines2.length; jj++) {
                        if (lines1[ii] === lines2[jj]) {
                            nextCommonI = ii;
                            nextCommonJ = jj;
                            break;
                        }
                    }
                    if (nextCommonI !== -1) break;
                }
                
                if (nextCommonI !== -1) {
                    // We found a common line ahead
                    const removedLines = lines1.slice(i, nextCommonI);
                    const addedLines = lines2.slice(j, nextCommonJ);
                    
                    if (removedLines.length > 0 && addedLines.length > 0) {
                        // Both sides have changes - treat as modified
                        result.push({
                            type: 'modified',
                            left: removedLines,
                            right: addedLines
                        });
                    } else if (removedLines.length > 0) {
                        // Only left side has changes
                        result.push({
                            type: 'removed',
                            lines: removedLines
                        });
                    } else if (addedLines.length > 0) {
                        // Only right side has changes
                        result.push({
                            type: 'added',
                            lines: addedLines
                        });
                    }
                    
                    i = nextCommonI;
                    j = nextCommonJ;
                } else {
                    // No more common lines
                    if (i < lines1.length) {
                        result.push({
                            type: 'removed',
                            lines: lines1.slice(i)
                        });
                    }
                    
                    if (j < lines2.length) {
                        result.push({
                            type: 'added',
                            lines: lines2.slice(j)
                        });
                    }
                    
                    break;
                }
            }
            
            return result;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Close modals when clicking outside of them
        window.onclick = function(event) {
            var explainModal = document.getElementById('explainModal');
            var explainDiffModal = document.getElementById('explainDiffModal');
            var sqlModal = document.getElementById('sqlModal');
            
            if (event.target == explainModal) {
                explainModal.style.display = "none";
            } else if (event.target == explainDiffModal) {
                explainDiffModal.style.display = "none";
            } else if (event.target == sqlModal) {
                sqlModal.style.display = "none";
            }
        };
        
        // Function to check if two plans are identical
        function arePlansIdentical(plan1, plan2) {
            if (!plan1 || !plan2) return false;
            
            const lines1 = plan1.split('\n');
            const lines2 = plan2.split('\n');
            
            if (lines1.length !== lines2.length) return false;
            
            for (let i = 0; i < lines1.length; i++) {
                if (lines1[i] !== lines2[i]) return false;
            }
            
            return true;
        }
        
        // Table sorting function with comprehensive error handling
        function sortTable(table, column, asc) {
            // Validate table and its structure
            if (!table || !table.tBodies || table.tBodies.length === 0) {
                console.error('Invalid table element or missing tbody');
                return;
            }
            
            const dirModifier = asc ? 1 : -1;
            const tBody = table.tBodies[0];
            const rows = Array.from(tBody.querySelectorAll('tr'));
            
            // If no rows to sort, exit early
            if (rows.length === 0) {
                console.warn('No rows to sort');
                return;
            }
            
            // Sort each row
            const sortedRows = rows.sort((a, b) => {
                // Safely get cell elements
                const aCell = a.querySelector(`td:nth-child(${column + 1})`);
                const bCell = b.querySelector(`td:nth-child(${column + 1})`);
                
                // Handle missing cells
                if (!aCell || !bCell) {
                    console.warn('Missing cell for sorting', { row: a, column });
                    return 0;
                }
                
                // Get text content safely
                let aColText = aCell.textContent ? aCell.textContent.trim() : '';
                let bColText = bCell.textContent ? bCell.textContent.trim() : '';
                
                // Remove the [identical] text if present for comparison
                aColText = aColText.replace(/\s*\[identical\]\s*$/, '');
                bColText = bColText.replace(/\s*\[identical\]\s*$/, '');
                
                // Remove % sign if present
                aColText = aColText.replace('%', '');
                bColText = bColText.replace('%', '');
                
                // Convert to number if possible
                const aValue = isNaN(parseFloat(aColText)) ? aColText : parseFloat(aColText);
                const bValue = isNaN(parseFloat(bColText)) ? bColText : parseFloat(bColText);
                
                // Compare values based on their types
                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    return aValue.localeCompare(bValue) * dirModifier;
                } else {
                    return (aValue > bValue ? 1 : -1) * dirModifier;
                }
            });
            
            try {
                // Remove all existing rows from the table
                while (tBody.firstChild) {
                    tBody.removeChild(tBody.firstChild);
                }
                
                // Add sorted rows
                tBody.append(...sortedRows);
                
                // Update sorting indicators
                const headers = table.querySelectorAll('th');
                if (headers) {
                    headers.forEach(th => th.classList.remove('asc', 'desc'));
                    
                    const targetHeader = table.querySelector(`th:nth-child(${column + 1})`);
                    if (targetHeader) {
                        targetHeader.classList.add(asc ? 'asc' : 'desc');
                    }
                }
            } catch (error) {
                console.error('Error updating table after sorting:', error);
            }
        }
        
        // Add event listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // For regular explain cells
            var explainCells = document.querySelectorAll('.explain-cell');
            explainCells.forEach(function(cell) {
                cell.addEventListener('click', function() {
                    var row = this.closest('tr');
                    var queryName = this.getAttribute('data-query');
                    var method = this.getAttribute('data-method');
                    var plan;
                    
                    // Get the plan based on the method
                    if (method === 'Raw') {
                        plan = row.querySelector('.raw-explain').value;
                    } else if (method === 'Standard') {
                        plan = row.querySelector('.standard-explain').value;
                    } else if (method === 'Histogram') {
                        plan = row.querySelector('.histogram-explain').value;
                    }
                    
                    showExplain(queryName, method, plan);
                });
            });
            
            // For explain diff cells
            var explainDiffCells = document.querySelectorAll('.explain-diff-cell');
            explainDiffCells.forEach(function(cell) {
                
                cell.addEventListener('click', function() {
                    var row = this.closest('tr');
                    var queryName = this.getAttribute('data-query');
                    var method1 = this.getAttribute('data-method1');
                    var method2 = this.getAttribute('data-method2');
                    var plan1, plan2;
                    
                    // Get the plans based on the methods
                    if (method1 === 'Raw') {
                        plan1 = row.querySelector('.raw-explain').value;
                    } else if (method1 === 'Standard') {
                        plan1 = row.querySelector('.standard-explain').value;
                    } else if (method1 === 'Histogram') {
                        plan1 = row.querySelector('.histogram-explain').value;
                    }
                    
                    if (method2 === 'Raw') {
                        plan2 = row.querySelector('.raw-explain').value;
                    } else if (method2 === 'Standard') {
                        plan2 = row.querySelector('.standard-explain').value;
                    } else if (method2 === 'Histogram') {
                        plan2 = row.querySelector('.histogram-explain').value;
                    }
                    
                    showExplainDiff(queryName, method1, method2, plan1, plan2);
                });
            });
            
            // For sortable table headers
            document.querySelectorAll('.sortable').forEach(function(header, index) {
                header.addEventListener('click', function() {
                    const isAscending = !this.classList.contains('asc');
                    const tableElement = this.closest('table');
                    if (tableElement) {
                        sortTable(tableElement, index, isAscending);
                    } else {
                        console.error('Could not find table element');
                    }
                });
            });
        });
    </script>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="app-title">Analyze Method Comparison</h1>
                </div>
            </div>
        </header>
        
        <div class="description">
            <p>Comparison of query execution times between different analyze methods:</p>
            <ul class="method-descriptions">
                <li><strong>Raw</strong>: <code>No ANALYZE</code></li>
                <li><strong>Standard</strong>: <code>ANALYZE table</code></li>
                <li><strong>Histogram</strong>: <code>SET enable_analyze_histogram = 1; ANALYZE table</code></li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <main class="main">
            
            <!-- Stats Overview -->
            <div class="stats-overview">
                <div class="stat-item">
                    <div class="stat-value">{{ comparison_data.total_queries }}</div>
                    <div class="stat-label">Total Queries</div>
                </div>
                <div class="stat-item raw-faster">
                    <div class="stat-value">{{ comparison_data.raw_faster }} ({{ "%.1f"|format(comparison_data.raw_faster_pct) }}%)</div>
                    <div class="stat-label">Raw Faster</div>
                </div>
                <div class="stat-item standard-faster">
                    <div class="stat-value">{{ comparison_data.standard_faster }} ({{ "%.1f"|format(comparison_data.standard_faster_pct) }}%)</div>
                    <div class="stat-label">Standard Analyze Faster</div>
                </div>
                <div class="stat-item histogram-faster">
                    <div class="stat-value">{{ comparison_data.histogram_faster }} ({{ "%.1f"|format(comparison_data.histogram_faster_pct) }}%)</div>
                    <div class="stat-label">Histogram Analyze Faster</div>
                </div>
            </div>
    
            <!-- Query Comparison Section -->
            <div class="logs-container">
                <div class="logs-header">
                    <div class="logs-title">
                        <h2>Query Execution Time Comparison</h2>
                    </div>
                </div>
                
                <table class="comparison-table">
            <tr>
                <th class="sortable" data-sort="name">Query ID</th>
                <th class="sortable" data-sort="raw_time">Raw Time (s)</th>
                <th class="sortable" data-sort="standard_time">Standard Time (s)</th>
                <th class="sortable" data-sort="histogram_time">Histogram Time (s)</th>
                <th class="sortable" data-sort="std_vs_raw">Std vs Raw (%)</th>
                <th class="sortable" data-sort="hist_vs_raw">Hist vs Raw (%)</th>
                <th class="sortable" data-sort="hist_vs_std">Hist vs Std (%)</th>
                <th class="sortable" data-sort="fastest_method">Fastest Method</th>
            </tr>
            {% for query in comparison_data.queries %}
            <tr>
                <td class="clickable" onclick="showSql('{{ query.name }}', this.parentNode.querySelector('.sql-data').value)" title="Click to view full SQL">{{ query.name }}</td>
                <td class="clickable explain-cell" data-query="{{ query.name }}" data-method="Raw" title="Click to view Raw execution plan">{{ "%.3f"|format(query.raw_time) }}</td>
                <td class="clickable explain-cell" data-query="{{ query.name }}" data-method="Standard" title="Click to view Standard execution plan">{{ "%.3f"|format(query.standard_time) }}</td>
                <td class="clickable explain-cell" data-query="{{ query.name }}" data-method="Histogram" title="Click to view Histogram execution plan">{{ "%.3f"|format(query.histogram_time) }}</td>
                <td class="clickable explain-diff-cell {{ 'noise' if -15 <= query.std_vs_raw <= 15 else ('negative' if query.std_vs_raw < 0 else 'positive') }}" data-query="{{ query.name }}" data-method1="Standard" data-method2="Raw" title="Click to compare Standard vs Raw execution plans{% if -15 <= query.std_vs_raw <= 15 %} (Difference within 15%, considered statistical noise){% endif %}" {% if query.standard_explain == query.raw_explain %}style="background-color: #e8f5e9 !important;"{% endif %}>{{ "%.1f"|format(query.std_vs_raw) }}{% if query.standard_explain == query.raw_explain %} <span style="font-size: 0.8em; color: #2e7d32;">[identical]</span>{% endif %}</td>
                <td class="clickable explain-diff-cell {{ 'noise' if -15 <= query.hist_vs_raw <= 15 else ('negative' if query.hist_vs_raw < 0 else 'positive') }}" data-query="{{ query.name }}" data-method1="Histogram" data-method2="Raw" title="Click to compare Histogram vs Raw execution plans{% if -15 <= query.hist_vs_raw <= 15 %} (Difference within 15%, considered statistical noise){% endif %}" {% if query.histogram_explain == query.raw_explain %}style="background-color: #e8f5e9 !important;"{% endif %}>{{ "%.1f"|format(query.hist_vs_raw) }}{% if query.histogram_explain == query.raw_explain %} <span style="font-size: 0.8em; color: #2e7d32;">[identical]</span>{% endif %}</td>
                <td class="clickable explain-diff-cell {{ 'noise' if -15 <= query.hist_vs_std <= 15 else ('negative' if query.hist_vs_std < 0 else 'positive') }}" data-query="{{ query.name }}" data-method1="Histogram" data-method2="Standard" title="Click to compare Histogram vs Standard execution plans{% if -15 <= query.hist_vs_std <= 15 %} (Difference within 15%, considered statistical noise){% endif %}" {% if query.histogram_explain == query.standard_explain %}style="background-color: #e8f5e9 !important;"{% endif %}>{{ "%.1f"|format(query.hist_vs_std) }}{% if query.histogram_explain == query.standard_explain %} <span style="font-size: 0.8em; color: #2e7d32;">[identical]</span>{% endif %}</td>
                <td class="faster {{ query.fastest_method.lower() }}-faster">{{ query.fastest_method }}</td>
                <!-- Hidden fields inside the row to stay with data during sorting -->
                <input type="hidden" class="raw-explain" value="{{ query.raw_explain|e }}">
                <input type="hidden" class="standard-explain" value="{{ query.standard_explain|e }}">
                <input type="hidden" class="histogram-explain" value="{{ query.histogram_explain|e }}">
                <input type="hidden" class="sql-data" value="{{ query.sql_preview|e }}">
            </tr>
            {% endfor %}
                </table>
                
                <div class="table-notes">
                    <p><span class="noise-indicator">≈</span> Differences within ±15% are considered statistical noise, likely due to system load fluctuations, and do not represent significant performance differences.</p>
                </div>
            </div>
        </main>
        
        <!-- SQL Modal -->
        <div id="sqlModal" class="explain-modal">
            <div class="modal-content" style="width: 80%; max-width: 1200px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="sqlTitle">SQL Query</h3>
                    <div class="modal-actions">
                        <button class="copy-btn" onclick="copyModalContent('sqlContent')" title="Copy to clipboard">Copy</button>
                        <span class="close-btn" onclick="closeModal()"></span>
                    </div>
                </div>
                <div class="modal-body" style="max-height: 80vh;">
                    <pre class="sql-content" id="sqlContent" style="white-space: pre-wrap; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 14px; line-height: 1.5; padding: 16px; overflow: auto; background-color: #f8f9fa; border-radius: 4px; margin: 0;"></pre>
                </div>
            </div>
        </div>
        
        <!-- Explain Modal -->
        <div id="explainModal" class="explain-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="explainTitle">Execution Plan</h3>
                    <div class="modal-actions">
                        <button class="copy-btn" onclick="copyModalContent('explainContent')" title="Copy to clipboard">Copy</button>
                        <span class="close-btn" onclick="closeModal()"></span>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="explain-content" id="explainContent"></div>
                </div>
            </div>
        </div>
        
        <!-- Explain Diff Modal -->
        <div id="explainDiffModal" class="explain-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="explainDiffTitle">Execution Plan Comparison</h3>
                    <div class="modal-actions">
                        <button class="copy-btn" onclick="copyModalContent('diffContent')" title="Copy to clipboard">Copy</button>
                        <span class="close-btn" onclick="closeDiffModal()"></span>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="diff-container">
                        <div class="explain-content" id="diffContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>